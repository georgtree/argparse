package require tcltest
namespace import ::tcltest::*
set currentDir [file normalize [file dirname [info script]]]
source [file join $currentDir argparse.tcl]

const templateProcStr {proc templateProc {args} {
    set arguments [argparse @additionalArgs@ {
        @definitions@
    }]
    set resultDict {}
    if {$arguments ne {}} {
        set exclude {args resultDict exclude}
    } else {
        set exclude {args resultDict arguments exclude}
    }
    foreach locVar [info locals] {
        if {$locVar in $exclude} {
            continue
        } else {
            dict append resultDict $locVar [subst $[subst $locVar]]
        }
    }
    return $resultDict
}}

proc testTemplate {testName descr arguments definitionsStr inputStr refStr} {
    variable templateProcStr
    test $testName $descr -body {
        eval [string map [list @definitions@ $definitionsStr @additionalArgs@ $arguments] $templateProcStr]
        if {[catch {set result [templateProc {*}$inputStr]} errorStr]} {
            return $errorStr
        } else {
            return $result
        }
    } -result $refStr -cleanup {
        rename templateProc {}
    }
}


### Only switches test without arguments
testTemplate onlySwitchNoArgsTest-1 {} {} {
-a
-b
-c} {-a -c} {a {} c {}}

testTemplate onlySwitchNoArgsTest-2 {} {} {
-a
-b
-c} {-a} {a {}}

testTemplate onlySwitchNoArgsTest-3 {} {} {
-a
-b
-c} {-a -c -b} {a {} b {} c {}}

testTemplate onlySwitchNoArgsTest-4 {} {} {
-a
-b
-c} {-a -c -b -k} {bad switch "-k": must be -a, -b, or -c}

testTemplate onlySwitchNoArgsTest-5 {} {} {
-a
-b
-c} {-a -c 1 -b} {too many arguments}

testTemplate onlySwitchNoArgsTest-6 {explicit -switch in element definition} {} {
{a -switch}
-b
-c} {-a -c} {a {} c {}}

testTemplate onlySwitchNoArgsTest-7 {} {} {
-a
-b
{-c -catchall}} {-a -c 1 2 3} {a {} c {1 2 3}}

testTemplate onlySwitchNoArgsTest-8 {} {} {
-a
{-b -require c}
{-c}} {-a -b} {-b requires -c}

testTemplate onlySwitchNoArgsTest-9 {} {} {
-a
{-b -require c}
{-c}} {-c -a -b} {a {} b {} c {}}

testTemplate onlySwitchNoArgsTest-10 {} {} {
-a
{-b -require {k c}}
-h
-c
-k} {-a -b} {-b requires -k}

testTemplate onlySwitchNoArgsTest-11 {} {} {
-a
{-b -require {k c}}
-h
-c
-k} {-a -b -k} {-b requires -c}

testTemplate onlySwitchNoArgsTest-12 {} {} {
-a
{-b -require {k c} -reciprocal}
-h
-c
-k} {-c} {-c requires -b}

testTemplate onlySwitchNoArgsTest-13 {} {} {
-a
{-b -require {k c} -reciprocal}
{-h -standalone}
-c
-k} {-c -h} {h {} c {}}

testTemplate onlySwitchNoArgsTest-14 {} {} {
-a
{-b -forbid {k c}}
-h
-c
-k} {-b -h -k} {-b conflicts with -k}

testTemplate onlySwitchNoArgsTest-14 {} {} {
-a
{-b -forbid {k c}}
-h
-c
-k} {-b -h} {h {} b {}}

testTemplate onlySwitchNoArgsTest-15 {} {} {
-a
-b
{-c -catchall}} {-c 1 2 3 -a} {c {1 2 3 -a}}

testTemplate onlySwitchNoArgsTest-16 {} {} {
{-a -key k}
-b
-c} {-a -c -b} {b {} c {} k {}}

# Bug?
testTemplate onlySwitchNoArgsTest-17 {} {} {
{-a -key k}
{-b -key k}
-c} {-a -c} {c {} k a}

testTemplate onlySwitchNoArgsTest-18 {} {} {
{-a -key k}
{-b -key k}
-c} {-a -c -b} {-a conflicts with -b}

testTemplate onlySwitchWArgsTest-19 {} {} {
-a
{-b -ignore}
-h
-c
-k} {-a -b -k -c} {a {} c {} k {}}

testTemplate onlySwitchWArgsTest-20 {} {} {
-a
{-be|b}
-h
-c
-k} {-a -be -k -c} {a {} b {} c {} k {}}

testTemplate onlySwitchWArgsTest-21 {} {} {
-a
{-b -alias be}
-h
-c
-k} {-a -be -k -c} {a {} b {} c {} k {}}

testTemplate onlySwitchNoArgsTest-22 {} {} {
-a
-b
-c} {-a -d} {bad switch "-d": must be -a, -b, or -c}

testTemplate onlySwitchNoArgsTest-23 {} {} {
-a} {-d} {bad switch "-d": must be -a}

### Only switches tests with arguments
testTemplate onlySwitchWArgsTest-1 {} {} {
-a=
-b=
-c=} {-a 1 -b 2 -c 3} {a 1 b 2 c 3}

testTemplate onlySwitchWArgsTest-2 {} {} {
-a=
-b=
-c=} {-a 1 -c 3} {a 1 c 3}

testTemplate onlySwitchWArgsTest-3 {} {} {
-a=
-b=
-c=} {-a 1 -c 3 -d 8} {bad switch "-d": must be -a, -b, or -c}

testTemplate onlySwitchWArgsTest-4 {} {} {
-a=
{-b= -required}
-c=} {-a 1 -c 3} {missing required switch: -b}

testTemplate onlySwitchWArgsTest-5 {} {} {
-a=
{-b= -required}
-c=} {-a 1 -c 3 -b} {-b requires an argument}

testTemplate onlySwitchWArgsTest-6 {} {} {
{a -switch -argument}
-b=
-c=} {-a 1 -b 2 -c 3} {a 1 b 2 c 3}

testTemplate onlySwitchWArgsTest-7 {} {} {
-a=
-b=
{-c= -catchall}} {-a 2 -b 3 -c 1 2 3} {a 2 b 3 c {1 2 3}}

testTemplate onlySwitchWArgsTest-8 {} {} {
-a=
-b=
{-c= -catchall}} {-a 2 -c 1 2 3 -b 3} {a 2 c {1 2 3 -b 3}}

testTemplate onlySwitchWArgsTest-9 {} {} {
-a=
{-b= -require {k c}}
-h=
-c=
-k=} {-a 1 -b 2 -k 3} {-b requires -c}

testTemplate onlySwitchWArgsTest-10 {} {} {
-a=
{-b= -require {k c}}
-h=
-c=
-k=} {-a 1 -b 2 -k 3 -c 2} {a 1 b 2 c 2 k 3}

testTemplate onlySwitchWArgsTest-11 {} {} {
-a=
{-b= -require {k c} -reciprocal}
-h=
-c=
-k=} {-c 2} {-c requires -b}

testTemplate onlySwitchWArgsTest-12 {} {} {
-a=
{-b= -require {k c} -reciprocal}
{-h= -standalone}
-c=
-k=} {-c 5 -h 10} {h 10 c 5}

testTemplate onlySwitchWArgsTest-13 {} {} {
-a=
{-b= -forbid {k c}}
-h=
-c=
-k=} {-b 1 -h 2 -k 3} {-b conflicts with -k}

testTemplate onlySwitchWArgsTest-14 {} {} {
-a=
{-b= -ignore}
-h=
-c=
-k=} {-a 1 -b 2 -k 3 -c 2} {a 1 c 2 k 3}

testTemplate onlySwitchWArgsTest-15 {} {} {
{-a= -default 10}
-b=
-h=
{-c= -default 20}
-k=} {-a 1 -b 2 -k 3} {a 1 b 2 c 20 k 3}

testTemplate onlySwitchWArgsTest-16 {} {} {
{-a -boolean}
-b=
-h=
{-c= -default 20}
-k=} {-b 2 -k 3} {a 0 b 2 c 20 k 3}

testTemplate onlySwitchWArgsTest-17 {} {} {
{-a -boolean}
-b=
-h=
{-c= -default 20}
-k=} {-a -b 2 -k 3} {a 1 b 2 c 20 k 3}

# Bug? -keep doesn't work as intended
testTemplate onlySwitchWArgsTest-18 {} {} {
-a=
-b=
-h=
{-c -keep}
-k=} {-a 5 -b 2 -k 3} {a 5 b 2 k 3}

testTemplate onlySwitchWArgsTest-19 {} {} {
{-a -key letter -value 1a}
{-b -key letter -value 1b}
{-h -key letter -value 1h}
{-c -key letter -value 1c}
-k=} {-a -k 3} {letter 1a k 3}

testTemplate onlySwitchWArgsTest-20 {} {} {
{-a -key letter -value 1a}
{-b -key letter -value 1b}
{-h -key letter -value 1h}
{-c -key letter -value 1c}
-k=} {-a -k 3 -c} {-a conflicts with -c}

testTemplate onlySwitchWArgsTest-21 {} {} {
{-a -key letter -value 1a}
{-b -key letter -value 1b}
{-h -key letter -value 1h}
{-c -key letter -value 1c -default 1c}
-k=} {-k 3} {letter 1c k 3}

testTemplate onlySwitchWArgsTest-22 {} {} {
-a=
{-b= -imply {-c} -required}
-c=} {-b 1 2} {b 1 c 2}

testTemplate onlySwitchWArgsTest-23 {} {} {
{-a= -argument}
-b=
-c=} {-a 1 -b 2 -c 3} {a 1 b 2 c 3}

testTemplate onlySwitchWArgsTest-24 {} {} {
-a=
{-b|ba= -required}
-c=} {-a 1 -c 3} {missing required switch: -b|ba}

testTemplate onlySwitchWArgsTest-25 {} {} {
{-a= -required}
{-b= -required}
-c=} {-c 3} {missing required switches: -a and -b}

testTemplate onlySwitchWArgsTest-26 {} {} {
{-a= -required}
{-b= -required}
{-c= -required}} {} {missing required switches: -a, -b, and -c}

### Only parameters tests 
testTemplate onlyParametersTest-1 {} {} {
a
b
c} {1 2 3} {a 1 b 2 c 3}

testTemplate onlyParametersTest-2 {} {} {
a
b?
c} {1 2} {a 1 c 2}

testTemplate onlyParametersTest-3 {} {} {
a
b?
c} {1 2 3} {a 1 b 2 c 3}

testTemplate onlyParametersTest-4 {} {} {
a
b
c?} {1 2} {a 1 b 2}

testTemplate onlyParametersTest-5 {} {} {
a
b
c?} {1 2 3} {a 1 b 2 c 3}

testTemplate onlyParametersTest-6 {} {} {
a?
b
c?
d
f?} {1 2} {d 2 b 1}

testTemplate onlyParametersTest-7 {} {} {
a?
b
c?
d
f?} {1 2 3} {d 3 a 1 b 2}

testTemplate onlyParametersTest-8 {} {} {
a?
b
c?
d
f?} {1 2 3 4} {d 4 a 1 b 2 c 3}

testTemplate onlyParametersTest-9 {} {} {
{a -optional}
b
c?
d
f?} {1 2 3 4 5} {d 4 a 1 f 5 b 2 c 3}

testTemplate onlyParametersTest-10 {} {} {
a?
b
c?
d
f?} {1 2 3 4 5 6} {too many arguments}

testTemplate onlyParametersTest-11 {} {} {
a
{b -forbid a}
c} {1 2 3} {a 1 b 2 c 3}

testTemplate onlyParametersTest-12 {} {} {
{a? -default 10}
b?
c} {1} {a 10 c 1}

testTemplate onlyParametersTest-13 {} {} {
{a? -default 10}
b
c} {1 2} {a 10 b 1 c 2}

testTemplate onlyParametersTest-14 {} {} {
{a? -default 10}
b?
c} {1 2} {a 1 c 2}

testTemplate onlyParametersTest-15 {} {} {
{a? -default 10}
b?
c} {1 2 3} {a 1 b 2 c 3}

# catch this situation?
testTemplate onlyParametersTest-16 {} {} {
{a? -require f}
b
c?
d
f?} {1 2 3} {d 3 a 1 b 2}

testTemplate onlyParametersTest-17 {} {} {
{a? -ignore}
b
c?
d
f?} {1 2 3} {d 3 b 2}

testTemplate onlyParametersTest-18 {} {} {
{a? -ignore}
{b -ignore}
c?
d
f?} {1 2 3} {d 3}

# doesnt work, same as with -switch element
testTemplate onlyParametersTest-19 {} {} {
{a? -keep}
b
c?
d
f?} {1 2} {d 2 b 1}

testTemplate onlyParametersTest-20 {} {} {
a
b
c} {1 2} {missing required parameter: c}

testTemplate onlyParametersTest-21 {} {} {
a
b
c} {1} {missing required parameters: b and c}

testTemplate onlyParametersTest-22 {} {} {
a
b
c} {} {missing required parameters: a, b, and c}

### Combination of switches and parameters tests 
testTemplate switchesParametersCombsTest-1 {} {} {
{-a= -required}
{-b= -default 10}
-c
d
e} {-a 1 -c 5 6} {d 5 e 6 a 1 b 10 c {}}

testTemplate switchesParametersCombsTest-2 {} {} {
{-a= -required}
{-b= -default 10}
-c
d
e} {-a 1 -b 9 -c 5 6} {d 5 e 6 a 1 b 9 c {}}

testTemplate switchesParametersCombsTest-3 {} {} {
{-a= -required}
{-b= -default 10}
-c
d
e} {-a 1 -b 9 -c 5 6} {d 5 e 6 a 1 b 9 c {}}

testTemplate switchesParametersCombsTest-4 {} {} {
-c
d
{-a= -required}
{-b= -default 10}
e} {-a 1 -b 9 -c 5 6} {d 5 e 6 a 1 b 9 c {}}

testTemplate switchesParametersCombsTest-5 {} {} {
-a=
{-b= -require {c k} -reciprocal}
{-h= -standalone}
-c=
{k -optional}} {-b 5 -h 10} {h 10 b 5}

### Wrong elements definitions tests
testTemplate wrongDefsTest-1 {} {} {
{-a -switch -argument}
-b=
-c=} {-a 1 -b 2 -c 3} {bad element name: -a}

### Check -exact option and prefixes of switches
testTemplate exactAndPrefixesTest-1 {} {} {
-cer=
-dta=
-art=
-bet=
-e=} {-ce 1 -be 9 -dt 5 -a 6 -e 1} {e 1 dta 5 cer 1 art 6 bet 9}

testTemplate exactAndPrefixesTest-2 {} {} {
-cer=
-cer1=
-art=
-bet=
-e=} {-ce 1 -be 9 -dt 5 -a 6 -e 1} {bad switch "-ce": must be -art, -bet, -cer, -cer1, or -e}

testTemplate exactAndPrefixesTest-3 {} {} {
-cer2=
-cer1=
-art=
-bet=
-e=} {-cer1 1 -be 9 -a 6 -e 1} {e 1 art 6 bet 9 cer1 1}

testTemplate exactAndPrefixesTest-4 {} {-exact} {
-cer=
-dta=
-art=
-bet=
-e=} {-ce 1 -be 9 -dt 5 -a 6 -e 1} {bad switch "-ce": must be -art, -bet, -cer, -dta, or -e}

testTemplate exactAndPrefixesTest-5 {} {-exact} {
-cer=
-dta=
-art=
-bet=
-e=} {-cer 1 -bet 9 -dta 5 -art 6 -e 1} {e 1 dta 5 cer 1 art 6 bet 9}

### Check -long option for switches
# add checking with mixed arguments and -- switch
testTemplate longTest-1 {} {-long} {
-cer=
-dta=
-art=
-bet=
-e=} {-cer 1 -bet 9 --dta 5 -art 6 --e 1} {e 1 dta 5 cer 1 art 6 bet 9}

testTemplate longTest-2 {} {} {
-cer=
-dta=
-art=
-bet=
-e=} {-cer 1 -bet 9 --dta 5 -art 6 --e 1} {too many arguments}

testTemplate longTest-3 {} {-long} {
-cer=
-dta=
-art=
-bet=
-e=} {-cer 1 -bet 9 --dta 5 -art 6 ---e 1} {too many arguments}

### Check -equalarg option for switches
testTemplate equalargTest-1 {} {-equalarg} {
-cer=
-dta=
-art=
-bet=
-e=} {-cer 1 -bet=9 -dta 5 -art 6 -e=1} {e 1 dta 5 cer 1 art 6 bet 9}

testTemplate equalargTest-2 {} {} {
-cer=
-dta=
-art=
-bet=
-e=} {-cer 1 -bet=9 -dta 5 -art 6 -e=1} {too many arguments}

### Check -inline option for switches
testTemplate inlineTest-1 {} {-inline} {
-cer=
-dta=
-art=
-bet=
-e=
lab
had} {-cer 1 -bet 9 -dta 5 -art 6 -e 1 4 5} {arguments {cer 1 bet 9 dta 5 art 6 e 1 lab 4 had 5}}

### Check -mixed option
testTemplate mixedTest-1 {} {-mixed} {
-cer=
-dta=
-art=
-bet=
-e=
lab
had} {-cer 1 -bet 9 4 5 -dta 5 -art 6 -e 1} {had 5 e 1 dta 5 cer 1 lab 4 art 6 bet 9}

testTemplate mixedTest-2 {} {-mixed} {
-cer=
-dta=
-art=
-bet=
-e=
lab
had} {-cer 1 -bet 9 4 -dta 5 -art 6 5 -e 1} {had 5 e 1 dta 5 cer 1 lab 4 art 6 bet 9}

testTemplate mixedTest-3 {} {-mixed} {
-cer=
-dta=
-art=
-bet=
-e=
lab
had} {4 -cer 1 -bet 9 -dta 5 -art 6 5 -e 1} {had 5 e 1 dta 5 cer 1 lab 4 art 6 bet 9}

testTemplate mixedTest-4 {} {-mixed} {
-cer=
-dta=
-art=
-bet=
-e=
lab
had} {4 -cer 1 -bet 9 -dta 5 -art 6 5 -e 1} {had 5 e 1 dta 5 cer 1 lab 4 art 6 bet 9}

testTemplate mixedTest-5 {} {-mixed} {
-cer=
-dta=
-art=
-bet=
-e=
lab
had} {-cer 1 -bet 9 -dta 5 -art 6 -e 1 -- 5 -likeaswitch} {had -likeaswitch e 1 dta 5 cer 1 lab 5 art 6 bet 9}

testTemplate mixedTest-6 {} {-mixed} {
-cer=
-dta=
-art=
-bet=
-e=
lab
had} {-cer 1 -bet 9 -dta 5 -art 6 -e 1 5 -likeaswitch} {bad switch "-likeaswitch": must be -art, -bet, -cer, -dta, or -e}

testTemplate mixedTest-7 {} {-mixed} {
-cer=
-dta=
-art=
-bet=
-e=
lab
had} {5 -likeaswitch -cer 1 -bet 9 -dta 5 -art 6 -e 1} {bad switch "-likeaswitch": must be -art, -bet, -cer, -dta, or -e}

testTemplate mixedTest-8 {} {} {
-cer=
-dta=
-art=
-bet=
-e=
lab
had} {-cer 1 -bet 9 -dta 5 -art 6 -e 1 5 -likeaswitch} {had -likeaswitch e 1 dta 5 cer 1 lab 5 art 6 bet 9}

testTemplate mixedTest-9 {} {-mixed} {
-cer=
-dta=
-art=
-bet=
-e=
lab
had} {-cer 1 -bet 9 -dta 5 -art 6 -e 1 -- 1 5} {had 5 e 1 dta 5 cer 1 lab 1 art 6 bet 9}

### Check -reciprocal option
testTemplate reciprocalTest-1 {} {-reciprocal} {
{-cer= -require {bet e}}
-dta=
-art=
-bet=
-e=
lab
had} {-bet 9 -dta 5 -art 6 -e 1 4 5} {-bet requires -cer}

### Check -pass option
testTemplate passTest-1 {} {-pass rest} {
-cer=
-dta=
-art=
-bet=
-e=
lab
had} {-bet 9 -dta 5 -art 6 -e 1 -k -l 786 4 5} {had 4 e 1 dta 5 rest {-k -l 5} lab 786 art 6 bet 9}

testTemplate passTest-2 {} {-pass rest} {
-cer=
-dta=
-art=
-bet=
-e=
lab
had} {-bet 9 -dta 5 -art 6 -e 1 -k 90 -l 786 4 5} {had -l e 1 dta 5 rest {-k 786 4 5} lab 90 art 6 bet 9}

testTemplate passTest-3 {} {-pass rest} {
-cer=
-dta=
-art=
-bet=
-e=} {-bet 9 -dta 5 -art 6 -e 1 -k 90 -l 786 4 5} {e 1 dta 5 rest {-k 90 -l 786 4 5} art 6 bet 9}

testTemplate passTest-4 {} {-pass rest} {
-cer=
-dta=
-art=
-bet=
{-e= -catchall}} {-bet 9 -dta 5 -art 6 -e 1 -k 90 -l 786 4 5} {e {1 -k 90 -l 786 4 5} dta 5 rest {} art 6 bet 9}

testTemplate passTest-5 {} {-pass rest} {
-cer=
-dta=
-art=
-bet=
{e -catchall}
lab
had} {4 5 -e 1 2 3} {had 3 e {4 5 -e 1} rest {} lab 2}
 
testTemplate passTest-6 {} {-pass rest} {
-cer=
-dta=
-art=
-bet=
{e -catchall -pass rest1}
lab
had} {- 5 -e 1 2 3} {had 3 rest {} lab 2 rest1 {-- - 5 -e 1}}

testTemplate passTest-7 {} {-pass rest} {
-cer=
-dta=
-art=
-bet=
{e -catchall}
lab
had} {- 5 -e 1 2 3} {had 3 e {- 5 -e 1} rest {} lab 2}

### Check -keep option
# doesn't work as it should? or if work as it should, what is the point if the option?
testTemplate keepTest-1 {} {-keep} {
-a=
-b=
-c
d
e} {1 2} {d 1 e 2}

### Check -normalize option
testTemplate normalizeTest-1 {} {-normalize -equalarg} {
-a=
-b=
{-c= -pass rest}
d
e} {-c=5 -a=4 1 2} {d 1 e 2 a 4 rest {-c 5}}

testTemplate normalizeTest-2 {} {-equalarg} {
-a=
-b=
{-c= -pass rest}
d
e} {-c=5 -a=4 1 2} {d 1 e 2 a 4 rest -c=5}

testTemplate normalizeTest-3 {} {-normalize -equalarg -long} {
{-a= -pass rest}
{-b= -pass rest}
{-c= -pass rest}
d
e} {-c=5 -a=4 --b 8 1 2} {d 1 e 2 rest {-c 5 -a 4 -b 8}}

testTemplate normalizeTest-4 {} {-normalize -equalarg -long} {
{-a= -pass rest -default 5}
{-b= -pass rest}
{-c= -pass rest}
d
e} {-b=4 1 2} {d 1 e 2 rest {-b 4 -a 5}}

testTemplate normalizeTest-5 {} {-equalarg -long} {
{-a= -pass rest -default 5}
{-b= -pass rest}
{-c= -pass rest}
d
e} {-b=4 1 2} {d 1 e 2 rest -b=4}

testTemplate normalizeTest-6 {} {-normalize -equalarg -long} {
{-a= -pass rest -default 5}
{-b= -pass rest}
{-c= -pass rest}
{d -optional -pass rest -default 10}
e} {-b=4 1} {e 1 rest {-b 4 -a 5 10}}

testTemplate normalizeTest-7 {} {-equalarg -long} {
{-a= -pass rest -default 5}
{-b= -pass rest}
{-c= -pass rest}
{d -optional -pass rest -default 10}
e} {-b=4 1} {e 1 rest -b=4}

testTemplate normalizeTest-8 {} {-normalize -equalarg -long -mixed} {
{-a= -pass rest -default 5}
{-b= -pass rest -default 6}
{-c= -pass rest -default 7}
{d -optional -pass rest -default 10}
{e -optional -pass rest -default 11}
{k -optional -pass rest -default 12}} {-b=4 1} {rest {-b 4 -a 5 -c 7 1 11 12}}

testTemplate normalizeTest-9 {} {-equalarg -long -mixed} {
{-a= -pass rest -default 5}
{-b= -pass rest -default 6}
{-c= -pass rest -default 7}
{d -optional -pass rest -default 10}
{e -optional -pass rest -default 11}
{k -optional -pass rest -default 12}} {-b=4 1} {rest {-b=4 1}}

testTemplate normalizeTest-10 {} {-normalize -mixed} {
{d -optional -pass rest -default 10}
{e -optional -pass rest -default 11}
{k -optional -pass rest -default 12}} {-1 2} {rest {-- -1 2 12}}

testTemplate normalizeTest-11 {} {-normalize -equalarg} {
-a=
-b=
{-cabn= -pass rest}
d
e} {-c=5 -a=4 1 2} {d 1 e 2 a 4 rest {-cabn 5}}

testTemplate normalizeTest-12 {} {} {
-a=
-b=
{-cabn= -pass rest}
d
e} {-c 5 -a 4 1 2} {d 1 e 2 a 4 rest {-c 5}}

testTemplate normalizeTest-13 {} {-normalize -mixed} {
{d -optional -pass rest }
{e -optional -pass rest -default 11}
{k -optional -pass rest -default 12}} {} {rest {11 12}}

testTemplate normalizeTest-14 {} {-normalize} {
{-a|ban= -pass rest -default 10}
-b=
{-cabn= -pass rest}
d
e} {-c 5 -a 15 1 2} {d 1 e 2 rest {-cabn 5 -ban 15}}

testTemplate normalizeTest-15 {} {-normalize} {
{-a|ban= -pass rest -default 10}
-b=
{-cabn= -pass rest}
d
e} {-c 5 -a 15 1 2} {d 1 e 2 rest {-cabn 5 -ban 15}}

testTemplate normalizeTest-16 {} {-normalize} {
{-a|ban= -pass rest -default 10}
-b=
{-cabn= -pass rest}
d
e} {-c 5 -a 15 1 2} {d 1 e 2 rest {-cabn 5 -ban 15}}

testTemplate normalizeTest-17 {} {-normalize -pass rest1} {
{-a|ban= -pass rest -default 10}
-b=
{-cabn= -pass rest}
d
e} {-c 5 -a 15 1 2} {d 1 e 2 rest {-cabn 5 -ban 15} rest1 {}}

testTemplate normalizeTest-18 {} {-normalize -mixed} {
{d -optional -pass rest1 -default -}
{e -optional -pass rest -default -}
{k -optional -pass rest -default -}} {-} {rest {-- - -} rest1 {-- -}}

### Check -boolean option
testTemplate booleanTest-1 {} {-boolean} {
-a
-b
-c} {-a} {a 1 b 0 c 0}

### Check global -validate option
testTemplate validateTest-1 {} {-validate [dict create check1 {[string is double $arg]} check2 {[string is integer $arg]}]} {
{-a= -validate check1}
-b=
{-c= -validate check2}} {-a 1 -b 2 -c 4} {a 1 b 2 c 4}

testTemplate validateTest-2 {} {-validate [dict create check1 {[string is double $arg]} check2 {[string is integer $arg]}]} {
{-a= -validate check1}
-b=
{-c= -validate check2}} {-a n -b 2 -c 4} {-a value "n" fails check1 validation}

testTemplate validateTest-3 {} {-validate [dict create check1 {[string is double $arg]} check2 {[string is integer $arg]}]} {
{-a= -validate check1}
-b=
{-c= -validate check2}} {-a 1 -b 2 -c 4.5} {-c value "4.5" fails check2 validation}

testTemplate validateTest-4 {} {-validate [dict create check1 {[string is double $arg]} check2 {[string is integer $arg]}]} {
{a -validate check1}
-b=
{c -validate check2}} {-b 1 2 4} {a 2 b 1 c 4}

testTemplate validateTest-5 {} {-validate [dict create check1 {[string is double $arg]} check2 {[string is integer $arg]}]} {
{a -validate check1}
-b=
{c -validate check2}} {-b 1 n 4} {a value "n" fails check1 validation}

testTemplate validateTest-6 {} {-validate [dict create check1 {[string is double $arg]} check2 {[string is integer $arg]}]} {
{a -validate check1}
-b=
{c -validate check2}} {-b 1 1 4.5} {c value "4.5" fails check2 validation}

### Check inline -validate option
testTemplate validateInlineTest-1 {} {} {
{-a= -validate {[string is double $arg]}}
-b=
{-c= -validate {[string is integer $arg]}}} {-a 1 -b 2 -c 4} {a 1 b 2 c 4}

testTemplate validateInlineTest-2 {} {} {
{-a= -validate {[string is double $arg]}}
-b=
{-c= -validate {[string is integer $arg]}}} {-a n -b 2 -c 4} {-a value "n" fails validation: [string is double $arg]}

testTemplate validateInlineTest-3 {} {} {
{-a= -validate {[string is double $arg]}}
-b=
{-c= -validate {[string is integer $arg]}}} {-a 1 -b 2 -c 4.5} {-c value "4.5" fails validation: [string is integer $arg]}

testTemplate validateInlineTest-4 {} {} {
{a -validate {[string is double $arg]}}
-b=
{c -validate {[string is integer $arg]}}} {-b 1 2 4} {a 2 b 1 c 4}

testTemplate validateInlineTest-5 {} {} {
{a -validate {[string is double $arg]}}
-b=
{c -validate {[string is integer $arg]}}} {-b 1 n 4} {a value "n" fails validation: [string is double $arg]}

testTemplate validateInlineTest-6 {} {} {
{a -validate {[string is double $arg]}}
-b=
{c -validate {[string is integer $arg]}}} {-b 1 1 4.5} {c value "4.5" fails validation: [string is integer $arg]}

### Check global -enum option
testTemplate enumTest-1 {} {-enum [dict create check1 {i o p} check2 {k m o}]} {
{-a= -enum check1}
-b=
{-c= -enum check2}} {-a o -b 2 -c m} {a o b 2 c m}

testTemplate enumTest-2 {} {-enum [dict create check1 {i o p} check2 {k m o}]} {
{-a= -enum check1}
-b=
{-c= -enum check2}} {-a y -b 2 -c m} {bad -a value "y": must be i, o, or p}

testTemplate enumTest-3 {} {-enum [dict create check1 {i o p} check2 {k m o}]} {
{-a= -enum check1}
-b=
{-c= -enum check2}} {-a o -b 2 -c p} {bad -c value "p": must be k, m, or o}

testTemplate enumTest-4 {} {-enum [dict create check1 {i o p} check2 {k m o}]} {
{a -enum check1}
-b=
{c -enum check2}} {-b 1 o m} {a o b 1 c m}

testTemplate enumTest-5 {} {-enum [dict create check1 {i o p} check2 {k m o}]} {
{a -enum check1}
-b=
{c -enum check2}} {-b 1 y m} {bad a value "y": must be i, o, or p}

testTemplate enumTest-6 {} {-enum [dict create check1 {i o p} check2 {k m o}]} {
{a -enum check1}
-b=
{c -enum check2}} {-b 1 o p} {bad c value "p": must be k, m, or o}

### Check inline -enum option
testTemplate enumInlineTest-1 {} {} {
{-a= -enum {i o p}}
-b=
{-c= -enum {k m o}}} {-a o -b 2 -c m} {a o b 2 c m}

testTemplate enumInlineTest-2 {} {} {
{-a= -enum {i o p}}
-b=
{-c= -enum {k m o}}} {-a y -b 2 -c m} {bad -a value "y": must be i, o, or p}

testTemplate enumInlineTest-3 {} {} {
{-a= -enum {i o p}}
-b=
{-c= -enum {k m o}}} {-a o -b 2 -c p} {bad -c value "p": must be k, m, or o}

testTemplate enumInlineTest-4 {} {} {
{a -enum {i o p}}
-b=
{c -enum {k m o}}} {-b 1 o m} {a o b 1 c m}

testTemplate enumInlineTest-5 {} {} {
{a -enum {i o p}}
-b=
{c -enum {k m o}}} {-b 1 y m} {bad a value "y": must be i, o, or p}

testTemplate enumInlineTest-6 {} {} {
{a -enum {i o p}}
-b=
{c -enum {k m o}}} {-b 1 o p} {bad c value "p": must be k, m, or o}

### Check -upvar option
test upvarTest-1 {} -body {
    proc upvarProc {args} {
        argparse {
            {a -upvar}
            b
            c
        }
        set a "$b+$c"
    }
    upvarProc p 1 2
    return $p
} -result 1+2 -cleanup {
    rename upvarProc {}
    unset p
}

test upvarTest-2 {} -body {
    proc upvarProc {args} {
        argparse {
            {-a= -upvar}
            b
            c
        }
        set a "$b+$c"
    }
    upvarProc -a p 1 2
    return $p
} -result 1+2 -cleanup {
    rename upvarProc {}
    unset p
}

test upvarTest-3 {} -body {
    proc upvarProc {args} {
        argparse {
            {-a= -key j -upvar}
            {-b= -key j -upvar}
            c
        }
        set a $c
        set b $c
    }
    catch {upvarProc -a p -b p 1} errorStr
    return $errorStr
} -result {multiple upvars to the same variable: a b} -cleanup {
    rename upvarProc {}
    unset errorStr
}

### Check -- option
testTemplate --Test-6 {} {-normalize -equalarg -long --} {
{-a= -pass rest -default 5}
{-b= -pass rest}
{-c= -pass rest}
{d -optional -pass rest -default 10}
e} {-b=4 1} {e 1 rest {-b 4 -a 5 10}}

### Check -template option
test templateTest-1 {} -body {
    proc templateOptProc {args} {
        argparse -template apopts(%) {
            a
            b
            c
        }
        foreach {name value} [array get apopts] {
            dict append result $name $value
        }
        return $result
    }
    templateOptProc p 1 2
} -result {a p b 1 c 2} -cleanup {
    rename templateOptProc {}
}

test templateTest-2 {} -body {
    proc templateOptProc {args} {
        argparse -template apopts(%) {
            a
            b
            -c=
        }
        foreach {name value} [array get apopts] {
            dict append result $name $value
        }
        return $result
    }
    templateOptProc -c 2 p 1 
} -result {a p b 1 c 2} -cleanup {
    rename templateOptProc {}
}

test templateTest-3 {} -body {
    proc templateOptProc {args} {
        argparse {
            {a -key apopts(a)}
            {b -key apopts(b)}
            {-c= -key apopts(-c)}
        }
        foreach {name value} [array get apopts] {
            dict append result $name $value
        }
        return $result
    }
    templateOptProc -c 2 p 1 
} -result {-c 2 a p b 1} -cleanup {
    rename templateOptProc {}
}
### Check specific options variants
test specOptsTest-1 {} -body {
    proc specOptsProc {args} {
        argparse {} {} {}
        return
    }
    catch {specOptsProc p 1 2} errorStr
    return $errorStr
} -result {too many arguments} -cleanup {
    rename specOptsProc {}
}

test specOptsTest-2 {} -body {
    proc specOptsProc {args} {
        argparse
        return
    }
    catch {specOptsProc p 1 2} errorStr
    return $errorStr
} -result {missing required parameter: definition} -cleanup {
    rename specOptsProc {}
}

test specOptsTest-3 {} -body {
    proc specOptsProc {} {
        argparse {} {}
        return
    }
    catch {specOptsProc} errorStr
    return $errorStr
} -result {} -cleanup {
    rename specOptsProc {}
}

test specOptsTest-4 {} -body {
    proc specOptsProc {args} {
        argparse {
            b
            c
        } $args
        return [list $b $c]
    }
    specOptsProc 2 3
} -result {2 3} -cleanup {
    rename specOptsProc {}
}

### Check comments in definition
testTemplate commentTest-1 {} {} {
-a
# comment1
-b
{# comment2}
-c} {-a -c} {a {} c {}}

testTemplate commentTest-2 {} {} {
-a
# comment1
-b
{#comment2}
-c} {-a -c} {bad element shorthand: #comment2}

testTemplate commentTest-3 {} {} {
-a
#
-b
{# comment2}
-c} {-a -c} {a {} c {}}

### Conflicting and wrong definitions tests
testTemplate conflictsInDefsTest-1 {} {} {
{-a -parameter}} {} {bad element name: -a}

testTemplate conflictsInDefsTest-2 {} {} {
{a -parameter -switch}} {} {-switch and -parameter conflict}

testTemplate conflictsInDefsTest-3 {} {} {
{-a -switch}} {} {bad element name: -a}

testTemplate conflictsInDefsTest-4 {} {} {
{-a -ignore -key A}} {} {-ignore and -key conflict}

testTemplate conflictsInDefsTest-5 {} {} {
{-a -ignore -pass A}} {} {-ignore and -pass conflict}

testTemplate conflictsInDefsTest-6 {} {} {
{-a -ignore -pass A}} {} {-ignore and -pass conflict}

testTemplate conflictsInDefsTest-7 {} {} {
{-a -default 1 -required}} {} {-required and -default conflict}
# issue with keep?
testTemplate conflictsInDefsTest-8 {} {} {
{-a -default 1 -keep}} {} {a 1}

testTemplate conflictsInDefsTest-9 {} {-inline} {
{-a -keep }} {} {-inline and -keep conflict}

testTemplate conflictsInDefsTest-10 {} {} {
{-a= -value A}} {} {-argument and -value conflict}

testTemplate conflictsInDefsTest-11 {} {} {
{a -value A}} {} {-parameter and -value conflict}

testTemplate conflictsInDefsTest-12 {} {-inline -keep} {
{-a}} {} {-inline and -keep conflict}

testTemplate conflictsInDefsTest-13 {} {-inline} {
{-a= -upvar}} {} {-upvar and -inline conflict}
# add upvar conflicts!

testTemplate conflictsInDefsTest-14 {} {} {
{a -switch -optional -catchall}} {} {-switch -optional -catchall is a disallowed combination}

testTemplate conflictsInDefsTest-15 {} {} {
{a -switch -optional -upvar}} {} {-switch -optional -upvar is a disallowed combination}

testTemplate conflictsInDefsTest-16 {} {} {
{a -switch -optional -default 1}} {} {-switch -optional -default is a disallowed combination}

# bug?? should be '-switch -optional -boolean is a disallowed combination'
testTemplate conflictsInDefsTest-17 {} {} {
{a -switch -boolean -optional}} {} {-argument and -boolean conflict}

testTemplate conflictsInDefsTest-18 {} {} {
{a -parameter -optional -required}} {} {-parameter -optional -required is a disallowed combination}

testTemplate conflictsInDefsTest-19 {} {} {
{a -catchall}
{b -catchall}} {1 1} {multiple catchall parameters: a and b}

testTemplate conflictsInDefsTest-20 {} {} {
{-a= -upvar -type double}
{b -catchall}} {1 1} {-type and -upvar conflict}

### Requirements tests
testTemplate requirementsTest-1 {} {} {
{-a= -reciprocal}
-b
-a} {-a -b} {-reciprocal requires -require}

testTemplate requirementsTest-2 {} {} {
{-a= -level}
-b
-a} {-a -b} {-level requires -upvar}

### Misc tests
testTemplate miscTest-1 {} {} {
-a
{}
-b
{# comment2}
-c} {-a -c} {a {} c {}}

testTemplate miscTest-2 {} {} {
{-a= -enum}
-b
-c} {-a -c} {-enum requires an argument}

testTemplate miscTest-3 {} {} {
-a= 
-b
-a} {-a -b} {element name collision: a}

testTemplate miscTest-4 {} {} {
{-a= -alias $a} 
-b
-a} {-a -b} {bad alias: $a}

testTemplate miscTest-5 {} {} {
{-a= -alias n} 
{-b= -alias n} 
-a} {-a -b} {element alias collision: n}

testTemplate miscTest-6 {} {} {
{-a= -require t} 
{-b= -alias n} 
-g} {-a -b} {a -require references undefined element: t}

testTemplate miscTest-7 {} {} {
{-a= -key t} 
{-b= -alias n} 
{g -key t}} {-a -b} {a cannot use -argument because it shares a key with g}

testTemplate miscTest-8 {} {} {
{-a -key t} 
{-b= -alias n} 
{g -key t}} {-a -b} {g cannot be a parameter because it shares a key with a}

testTemplate miscTest-9 {} {} {
{-a -key t -default 1} 
{-g -key t -default 2}} {-a -g} {a and g cannot both use -default because they share a key}

testTemplate miscTest-10 {} {} {
{-a -key t -value 1} 
{-g -key t -value 2}} {-a -g} {-a conflicts with -g}

testTemplate miscTest-11 {} {} {
{-a -key t -value 1} 
{-g -key t -value 2}
{-k -key t -value 3}} {-a} {t 1}

testTemplate miscTest-12 {} {-normalize} {
-cer=
-dta=
-art=
-bet=
{-e= -catchall -pass rest}
lab
had} {-cer 1 -e 2 io p 4 5} {had 5 rest {-e 2 io p} cer 1 lab 4}

testTemplate miscTest-13 {} {} {
-cer=
-dta=
-art=
-bet=
{-e= -catchall -pass rest}
lab
had} {-cer 1 -e 2 io p 4 5} {had 5 rest {-e 2 io p} cer 1 lab 4}

testTemplate miscTest-14 {} {-normalize -equalarg} {
-cer=
-dta=
-art=
-bet=
-e
lab
had} {-e=1 -cer 1 4 5} {-e doesn't allow an argument}

testTemplate miscTest-15 {} {-normalize -equalarg} {
-cer=
-dta=
-art=
-bet=
{-e -pass rest}
lab
had} {-e -cer 1 4 5} {had 5 cer 1 rest -e lab 4}

testTemplate miscTest-16 {} {-normalize -equalarg} {
{-cer= -key j -optional}
-dta=
-art=
-bet=
{-e -key y}
lab
had} {-e -cer 1 4 5} {had 5 y {} j {{} 1} lab 4}

testTemplate miscTest-17 {} {-normalize -equalarg} {
{-cer= -optional -pass a}
-dta=
-art=
-bet=
{-e -key y}
{lab -optional}
had} {-e -cer 5} {had 5 a -cer y {}}

testTemplate miscTest-18 {} {-equalarg} {
{-cer= -optional -pass a}
-dta=
-art=
-bet=
{-e -key y}
{lab -optional}
had} {-e -cer 5} {had 5 a -cer y {}}

testTemplate miscTest-19 {} {-normalize -equalarg} {
{-cer= -optional}
-dta=
-art=
-bet=
{-e -key y}
{lab -optional}
had} {-e -cer 5} {had 5 y {} cer {}}

testTemplate miscTest-20 {} {-normalize -equalarg} {
{-cer= -key j -catchall}
-dta=
-art=
-bet=
{-e -key y}
lab
had} {-e 4 5} {had 5 y {} j {} lab 4}

### Check -type in definitions 
testTemplate typeTest-1 {} {} {
{-a= -type alpha}
{-b= -type boolean}
{c -type integer}} {-a y -b False 10} {a y b False c 10}

testTemplate typeTest-2 {} {} {
{-a= -type alpha1}
{-b= -type boolean}
{c -type integer}} {-a y -b False 10} {type alpha1 is not in the list of allowed types, must be alnum, alpha, ascii, boolean, control, dict, digit, double, graph, integer, list, lower, print, punct, space, upper, wideinteger, wordchar or xdigit}

testTemplate typeTest-3 {} {} {
{-a= -type alpha}
{-b= -type boolean}
{c -type integer}} {-a y -b False 10.1} {c value "10.1" is not of the type integer}

testTemplate typeTest-4 {} {} {
{-a= -type alpha}
{-b= -type boolean}
{c -type integer}} {-a y -b False -1} {a y b False c -1}

testTemplate typeTest-5 {} {} {
{-a= -type alpha}
{-b= -type boolean}
{c -type integer}} {-a y! -b False -1} {-a value "y!" is not of the type alpha}

testTemplate typeTest-6 {} {-mixed} {
{-a= -type alpha -catchall}
{-b= -type boolean}
{c -type integer}} {-b False 1 -a y ty qwq} {a {y ty qwq} b False c 1}

testTemplate typeTest-7 {} {-mixed} {
{-a= -type alpha -catchall}
{-b= -type boolean}
{c -type integer}} {-b False 1 -a y ty 1} {-a value "1" is not of the type alpha}



cleanupTests
